# CHTL项目深度分析文档

## 文档概述
CHTL是基于C++语言实现的超文本语言，其本质是为了提供一种更符合开发者编写HTML代码的方式，使用MIT开源协议。

## 第一部分：基础语法特性分析

### 1. 注释系统
- `//` 单行注释
- `/**/` 多行注释  
- `--` 生成器识别注释
- 前两种注释不会出现在生成的HTML中
- `--`注释会根据上下文生成不同编程语言类型的注释

### 2. 文本节点
- `text { }` 表示一段文本
- `text: "文本内容";` 作为属性在元素内部使用
- 支持无修饰字面量（无引号字符串）

### 3. 字面量支持
- 无修饰字面量（无引号字符串）
- 双引号字符串 `""`
- 单引号字符串 `''`
- 类似CSS的无引号语法

### 4. CE对等式
- `:` 与 `=` 完全等价
- 可在推荐情景下使用 `=`

### 5. 元素节点
- 支持所有HTML元素
- 支持单标签、双标签
- 支持块级、行内、行内块元素
- 使用花括号 `{}` 表示元素内容

### 6. 属性系统
- 使用 `属性名 : "属性值";` 格式
- 支持无修饰字面量
- 支持CE对等式

## 第二部分：局部样式块系统

### 1. 基本功能
- 允许在元素内部嵌套 `style {}`
- 支持内联样式、类选择器、id选择器、伪类选择器、伪元素选择器
- 类选择器、id选择器、伪类选择器、伪元素选择器自动添加至全局样式块

### 2. 内联样式
- 直接在 `style{}` 内部添加属性
- 属性成为元素的内联样式

### 3. 自动化类名/id
- 可直接在局部样式块中使用类/id选择器
- CHTL自动为元素添加类名/id
- 无需手动编写class/id

### 4. 上下文推导
- 使用 `&` 表示类名/id（优先类名）
- `&` 根据上下文推导成类名/id
- 支持 `&:hover`、`&::before` 等伪类/伪元素选择器

### 5. 属性运算
- 支持算术运算符 `+ - * / % **`
- `%` 为取模，`**` 为幂运算符
- 全局style支持此用法

### 6. 引用属性
- 引入指向属性概念
- 语法：`CSS选择器.属性`
- 支持的选择器：box（自动推断）、.box（类选择器）、#box（id选择器）、button（tag选择器）、.box button（后代选择器）、button[0]（精确访问）

### 7. 属性条件表达式
- 格式：`元素自身的属性的表达式 ? 选项 : 选项`
- 支持链式调用
- 支持可选选项
- 支持算术运算符和逻辑运算符（&&、||）
- 支持引用属性条件表达式

## 第三部分：模板系统

### 1. 样式组模板
- 使用 `[Template] @Style 组名` 创建
- 支持无修饰字面量
- 使用 `@Style 组名` 调用

### 2. 元素模板
- 使用 `[Template] @Element 元素名` 创建
- 使用 `@Element 元素名` 调用

### 3. 变量组模板
- 使用 `[Template] @Var 变量组名` 创建
- 使用 `变量组名(属性名)` 调用
- 无需 `--` 前缀，因为不是CSS变量

### 4. 组合继承
- 模板可以继承同种类型的模板
- 支持显性继承（`inherit`）

## 第四部分：自定义系统

### 1. 自定义样式组
- 使用 `[Custom] @Style 组名` 创建
- 支持无值样式组（属性不具有值）
- 支持样式组特例化（删除属性、删除样式组继承）

### 2. 自定义元素
- 使用 `[Custom] @Element 元素名` 创建
- 支持特例化操作
- 支持索引访问 `[index]`
- 支持插入元素（`insert`）
- 支持删除元素（`delete`）

### 3. 变量组
- 支持变量组特例化

### 4. 全缀名
- 支持使用全缀名访问模板元素、样式组、变量组、自定义元素等
- 用于处理命名冲突

## 第五部分：原始嵌入系统

### 1. 基本功能
- 使用 `[Origin]` 表示原始代码
- 原始代码不会被CHTL处理，直接生成
- 允许在任意节点中被解析

### 2. 嵌入类型
- `[Origin] @Html` - 嵌入HTML代码
- `[Origin] @Style` - 嵌入CSS代码
- `[Origin] @JavaScript` - 嵌入JS代码
- 支持带名原始嵌入

## 第六部分：导入系统

### 1. 导入HTML、CSS、JS文件
- `[Import] @Html from 文件路径 as 命名`
- `[Import] @Style from 文件路径 as 命名`
- `[Import] @JavaScript from 文件路径 as 命名`
- 支持路径搜索规则

### 2. 导入CHTL文件
- 精确导入：导入特定的自定义元素、样式组、变量组等
- 类型导入：导入所有特定类型的元素
- 通配导入：导入所有模板、自定义、原始嵌入
- 支持 `.` 和 `/` 对等式

## 第七部分：命名空间系统

### 1. 基本功能
- 使用 `[Namespace]` 创建命名空间
- 防止模块污染
- 支持嵌套命名空间

### 2. 命名空间规则
- 同名命名空间自动合并
- 未使用命名空间的文件默认以文件名作为命名空间
- 支持冲突检测策略

## 第八部分：约束系统

### 1. 精确约束
- 使用 `except` 关键字
- 可约束HTML元素、自定义与模板对象

### 2. 类型约束
- 可约束 `@Html`、`[Custom]`、`[Template]`

### 3. 全局约束
- 在命名空间内使用
- 支持前面列出的类型

## 第九部分：配置组系统

### 1. 基本配置
- 使用 `[Configuration]` 创建配置组
- 支持无修饰字面量
- 可配置索引起始计数、DEBUG模式等

### 2. Name配置
- 可修改关键字名称
- 支持组选项（多个值）
- 可禁用Name配置组

### 3. 命名配置组
- 配置组可以命名
- 命名配置组不会被使用
- 支持导入配置组

### 4. 其他配置
- 局部样式块自动化规则
- 默认命名空间配置
- 自定义原始嵌入类型

## 第十部分：use语法

### 1. HTML5类型
- `use html5;` 生成HTML5声明

### 2. 使用命名配置组
- `use @Config 配置组名;`
- 支持全缀名写法

## 第十一部分：CHTL JS系统

### 1. 基本概念
- CHTL JS是独立的编程语言
- 不是JS的超集，与JS无关
- 最终转变为JS代码
- 支持声明式语法

### 2. 文件系统
- 支持 `*.cjjs` 文件后缀
- 支持 `fileloader {}` 导入文件
- 实现AMD风格JavaScript文件加载器

### 3. 局部script
- 允许在局部样式块中使用 `script{}`
- 局部script被添加到全局script块中
- 支持增强选择器 `{{CSS选择器}}`

### 4. 增强功能
- 增强选择器：`{{选择器}}` 创建DOM对象
- 增强监听器：`listen` 快捷绑定事件监听器
- 事件委托：解决SPA页面元素动态更新问题
- 动画：封装 `requestAnimationFrame`
- 虚对象：提供访问CHTL JS函数元信息的能力
- 路由：快速创建SPA页面基本架构
- 动态属性条件表达式

## 第十二部分：模块系统

### 1. 模块路径
- 源码文件夹 → Module文件夹
- 官方模块目录 → 编译器二进制文件所在目录的module文件夹
- 用户模块目录 → 编译文件所在目录的module文件夹
- 支持无序结构和有序结构

### 2. CMOD
- CHTL提供的模块化方式
- 严格的模块结构：src + info
- 支持子模块
- 模块信息包含 `[Info]` 和 `[Export]`

### 3. CJMOD
- CHTL JS提供的模块化方式
- 使用CJMOD API实现CHTL JS语法扩展
- 严格的模块结构：src + info
- 支持子模块

### 4. CMOD + CJMOD混合模块
- 同时提供组件和扩展CHTL JS语法
- 使用src + info结构
- CMOD和CJMOD不共用信息文件

### 5. 通配符和官方模块
- 支持通配符导入
- 支持官方模块前缀 `chtl::`
- 包含Chtholly和Yuigahama模块

## 第十三部分：项目结构

### 1. 核心组件
- CHTL编译器
- CHTL JS编译器
- CSS编译器
- JS编译器
- 统一扫描器
- 代码合并器
- 编译器调度器

### 2. 项目流程
- 源代码 → 统一扫描器 → 编译器调度器 → 各编译器 → 代码合并器 → 最终输出

## 第十四部分：语法边界

### 1. 全局样式块
- 仅允许特定语法元素
- 包括模板变量、自定义变量等

### 2. script块
- 除局部script外，其他script禁止使用CHTL语法
- 局部script允许使用特定CHTL语法元素

## 第十五部分：CJMOD API

### 1. 核心类
- `Syntax`：语法分析类
- `Arg`：参数列表类
- `CJMODScanner`：统一扫描器接口
- `CJMODGenerator`：生成器接口
- `AtomArg`：原子参数
- `CHTLJSFunction`：CHTL JS函数

### 2. 扫描算法
- 双指针扫描
- 前置截取

## 第十六部分：统一扫描器

### 1. 核心机制
- 可变长度切片与智能扩增
- 占位符机制
- 宽判严判

### 2. 代码分离
- 完全分离CHTL JS和JS代码
- 利用占位符机制实现无痛分离

## 第十七部分：CLI和IDE

### 1. CLI工具
- 常规命令行
- 命令行程序（支持渲染、RGB等）

### 2. VSCode IDE
- 代码高亮、格式化、提示
- 页面预览、实时预览
- 内置编译器和官方模块
- 自动模块解包和JSON查询表

## 实现优先级分析

基于文档分析，CHTL项目的实现应该按照以下优先级进行：

### 第一阶段：核心基础功能
1. 词法分析器（Lexer）
2. 语法分析器（Parser）
3. 基础节点系统（ElementNode、TextNode等）
4. 基础代码生成器

### 第二阶段：样式系统
1. 局部样式块解析
2. 属性运算系统
3. 引用属性系统
4. 属性条件表达式

### 第三阶段：模板和自定义系统
1. 模板系统实现
2. 自定义系统实现
3. 继承机制

### 第四阶段：高级功能
1. 导入系统
2. 命名空间系统
3. 约束系统
4. 配置组系统

### 第五阶段：CHTL JS系统
1. CHTL JS词法分析器
2. CHTL JS语法分析器
3. CHTL JS代码生成器
4. 虚对象系统

### 第六阶段：模块系统
1. CMOD系统
2. CJMOD系统
3. 模块加载器

### 第七阶段：工具和IDE
1. CLI工具
2. VSCode扩展
3. 统一扫描器

这个分析为CHTL项目的完整实现提供了详细的路线图。